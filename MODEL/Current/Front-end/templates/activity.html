{% extends "base.html" %}
{% block title %}Activity Mode â€“ FSL Learning{% endblock %}
{% block content %}

<section class="section py-5" style="min-height:90vh;background:rgba(250,250,255,0.7);backdrop-filter:blur(6px);">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="fw-bold text-primary mb-0">ğŸ¯ Activity Mode</h4>
      <span id="stateBadge" class="badge bg-secondary text-dark fs-6 px-3 py-2 shadow-sm">State: READY</span>
    </div>

    <div class="row g-4 align-items-stretch mb-4">
      <!-- Camera feed + overlay -->
      <div class="col-lg-6 position-relative">
        <div class="card shadow-sm border-0 h-100 rounded-4 position-relative overflow-hidden">
          <video id="mainCamera" autoplay playsinline muted
                 style="width:100%;height:100%;background:#000;aspect-ratio:4/3;
                        border-radius:1rem;z-index:1;transform:scaleX(-1);"></video>

          <!-- Overlay canvas -->
          <canvas id="overlayCanvas"
                  style="position:absolute;top:0;left:0;width:100%;height:100%;
                         pointer-events:none;border-radius:1rem;z-index:2;"></canvas>

          <!-- Countdown + REC -->
          <div id="prepOverlay"
               class="position-absolute top-50 start-50 translate-middle fw-bold text-warning"
               style="font-size:3.2rem;display:none;z-index:8;text-shadow:3px 3px 8px #000;">Get Readyâ€¦</div>

          <div id="recBadge"
               class="position-absolute top-0 start-0 m-3 px-3 py-1 rounded-pill fw-bold"
               style="display:none;z-index:9;background:#b10000;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.3);">
               â— REC
          </div>
        </div>
      </div>

      <!-- Results + info -->
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 p-4 h-100 rounded-4">
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-start">
              <h6 class="text-muted mb-1">Selected Gesture</h6>
              <p id="targetLabel" class="fs-4 text-primary fw-bold mb-0">None</p>
            </div>
            <div id="resultText" class="fs-4 fw-bold text-secondary">â€”</div>
          </div>
          <hr>
          <div class="mb-2 d-flex justify-content-between align-items-center">
            <span id="capturePhase" class="text-muted">Idle</span>
            <span class="text-muted"><span id="frameCount">0</span>/48 frames</span>
          </div>
          <div class="progress" style="height:12px;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
          </div>
          <div class="d-flex justify-content-around mt-4">
            <div><span class="text-success fw-bold fs-5" id="correctCount">0</span><p class="mb-0">Correct</p></div>
            <div><span class="text-danger fw-bold fs-5" id="incorrectCount">0</span><p class="mb-0">Incorrect</p></div>
          </div>
          <p class="text-muted mt-3 mb-0">Start â†’ Get Ready (1 s) â†’ Perform â‰ˆ 5 s â†’ Auto-predict or Stop.</p>
        </div>
      </div>
    </div>

    <!-- Category selector -->
    <div class="card border-0 shadow-sm rounded-4 p-4 mb-4 text-center bg-white">
      <div class="mb-3">
        <button class="btn btn-outline-primary mx-2 fw-semibold category-btn" data-cat="numbers">ğŸ”¢ Numbers</button>
        <button class="btn btn-outline-primary mx-2 fw-semibold category-btn" data-cat="shapes">ğŸ“ Shapes</button>
        <button class="btn btn-outline-primary mx-2 fw-semibold category-btn" data-cat="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family</button>
        <button class="btn btn-outline-primary mx-2 fw-semibold category-btn" data-cat="colors">ğŸ¨ Colors</button>
      </div>
      <div id="gestureChoices" class="mt-3"></div>
    </div>

    <div class="text-center">
      <button id="startBtn" class="btn btn-success btn-lg shadow-sm">â–¶ Start</button>
      <button id="stopBtn" class="btn btn-danger btn-lg shadow-sm" style="display:none;">â¹ Stop</button>
    </div>

  </div>
</section>

<!-- MediaPipe libraries -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>

<!-- Activity logic -->
<script>
window.addEventListener("load", () => {
  const videoEl=document.getElementById("mainCamera");
  const canvasEl=document.getElementById("overlayCanvas");
  if(!canvasEl){console.error("âŒ overlayCanvas not found in DOM");return;}
  const ctx=canvasEl.getContext("2d");
  const startBtn=document.getElementById("startBtn");
  const stopBtn=document.getElementById("stopBtn");
  const stateBadge=document.getElementById("stateBadge");
  const targetLabel=document.getElementById("targetLabel");
  const resultText=document.getElementById("resultText");
  const correctCountEl=document.getElementById("correctCount");
  const incorrectCountEl=document.getElementById("incorrectCount");
  const capturePhase=document.getElementById("capturePhase");
  const frameCountEl=document.getElementById("frameCount");
  const progressBar=document.getElementById("progressBar");
  const prepOverlay=document.getElementById("prepOverlay");
  const recBadge=document.getElementById("recBadge");

  // HUD
  const hud=document.createElement("div");
  Object.assign(hud.style,{position:"absolute",right:"10px",bottom:"10px",zIndex:"10",
    background:"rgba(0,0,0,.5)",color:"#fff",font:"12px/1.2 system-ui,Segoe UI,Roboto,Arial",
    padding:"6px 8px",borderRadius:"8px",pointerEvents:"none"});
  hud.textContent="â€”";
  canvasEl.parentElement.appendChild(hud);

  const categories = {
  colors: [
    "Black", "Blue", "Brown", "Dark", "Gray", "Green", "Light",
    "Orange", "Pink", "Red", "Violet", "White", "Yellow"
  ],
  family: [
    "Auntie", "Cousin", "Daughter", "Father", "Grandfather", "Grandmother",
    "Mother", "Parents", "Son", "Uncle"
  ],
  numbers: [
    "One", "Two", "Three", "Four", "Five", "Six", "Seven",
    "Eight", "Nine", "Ten"
  ],
  shapes: ["Circle", "Square", "Triangle", "Rectangle"]
  };

  const STATE_READY=0,STATE_PREP=1,STATE_CAPTURE=2;
  let state=STATE_READY;
  function setState(s){state=s;stateBadge.textContent="State: "+["READY","PREP","CAPTURE"][s];}

  let targetGesture=null,correctCount=0,incorrectCount=0;
  const SEQ_LEN=48,CAPTURE_MAX=120;
  let buf=[],running=false,frameSkip=1,frameCounter=0,autoJudge=false;

  document.querySelectorAll(".category-btn").forEach(btn=>{
    btn.onclick=()=>{
      const list=categories[btn.dataset.cat]||[];
      document.getElementById("gestureChoices").innerHTML=list.map(g=>`<button class="btn btn-primary m-1 choiceBtn">${g}</button>`).join("");
      document.querySelectorAll(".choiceBtn").forEach(b=>{
        b.onclick=()=>{targetGesture=b.textContent;targetLabel.textContent=targetGesture;resultText.textContent="â€”";};
      });
    };
  });

  // -------------- helpers (Python-identical) --------------
  function flattenHand(lms){if(!lms)return new Float32Array(63);const a=[];for(let i=0;i<21;i++){const p=lms[i];a.push(p.x,p.y,p.z);}return new Float32Array(a);}
  function lm(list,idx){if(!list||idx>=list.length)return{x:0,y:0,z:0};return list[idx];}
  function dist2D(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy)||1e-6;}

  function normalizeGlobal(hand63,anchors){
    if(!hand63||hand63.length!==63||!anchors.L_SH||!anchors.R_SH)return new Float32Array(63);
    const out=new Float32Array(63);
    const Cx=(anchors.L_SH.x+anchors.R_SH.x)/2;
    const Cy=(anchors.L_SH.y+anchors.R_SH.y)/2;
    const Cz=(anchors.L_SH.z+anchors.R_SH.z)/2;
    const scale=Math.max(1e-6,dist2D(anchors.L_SH,anchors.R_SH));
    for(let i=0;i<63;i+=3){
      out[i]=(hand63[i]-Cx)/scale;
      out[i+1]=(hand63[i+1]-Cy)/scale;
      out[i+2]=(hand63[i+2]-Cz)/scale;
    }
    for(let i=0;i<63;i++)out[i]=Math.max(-5,Math.min(5,out[i]));
    return out;
  }

  function derivedAltitudeFeatures(L,R,anchors){
    const out=[];
    const brow_y=0.5*(anchors.brow_r.y+anchors.brow_l.y);
    const SEL=[0,4,8,12,16,20];
    for(const H of [L,R]){
      for(const j of SEL){
        const bx=j*3,by=bx+1,bz=bx+2;
        const py=H[by],pz=H[bz];
        out.push(
          py-anchors.chin.y,
          py-anchors.lip_u.y,
          py-brow_y,
          py-anchors.forehead.y,
          pz-anchors.nose.z
        );
      }
    }
    return new Float32Array(out);
  }

  function packFeature(res){
    const pose=res.poseLandmarks||[],face=res.faceLandmarks||[];
    const anchors={};
    anchors.L_SH=lm(pose,11);anchors.R_SH=lm(pose,12);
    anchors.nose=lm(face,1);anchors.forehead=lm(face,10);
    anchors.lip_u=lm(face,13);anchors.brow_r=lm(face,65);anchors.brow_l=lm(face,295);
    anchors.chin=lm(face,152);

    // invert handedness (same as training)
    const Lh=res.rightHandLandmarks?flattenHand(res.rightHandLandmarks):null;
    const Rh=res.leftHandLandmarks?flattenHand(res.leftHandLandmarks):null;
    const lf=Lh?1:0,rf=Rh?1:0;
    if(!Lh&&!Rh)return null;
    const L=normalizeGlobal(Lh,anchors),R=normalizeGlobal(Rh,anchors);
    const alt=derivedAltitudeFeatures(L,R,anchors);
    return new Float32Array([...L,...R,...alt,lf,rf]);
  }

  // -------------- identical temporalFix --------------
  function temporalFix(frames,seqLen=48){
    if(frames.length<=seqLen){
      const pad=Array.from({length:seqLen-frames.length},()=>frames[frames.length-1]);
      return frames.concat(pad);
    }
    const scores=new Array(frames.length).fill(0);
    for(let i=1;i<frames.length;i++){
      const f0=frames[i-1],f1=frames[i];if(!f0||!f1)continue;
      let motion=0;
      for(let j=0;j<f0.length-2;j++)motion+=Math.abs(f1[j]-f0[j]);
      motion/=(f0.length-2);
      const presence=f1[f1.length-2]+f1[f1.length-1];
      scores[i]=0.7*motion+0.3*presence;
    }
    const W=Math.min(40,frames.length);let bestStart=0,bestSum=-1e9;
    let runSum=0;for(let i=0;i<W;i++)runSum+=scores[i];bestSum=runSum;
    for(let i=1;i<=scores.length-W;i++){
      runSum+=scores[i+W-1]-scores[i-1];
      if(runSum>bestSum){bestSum=runSum;bestStart=i;}
    }
    const selected=frames.slice(bestStart,bestStart+W);
    const step=selected.length/seqLen;
    const aligned=[];
    for(let i=0;i<seqLen;i++){
      const idx=Math.min(Math.floor(i*step),selected.length-1);
      aligned.push(selected[idx]);
    }
    return aligned;
  }

  // ----------------------------------------------
  function updateBuffer(f){
    if(buf.length<CAPTURE_MAX)buf.push(f);else{buf.shift();buf.push(f);}
    frameCountEl.textContent=Math.min(buf.length,SEQ_LEN);
    progressBar.style.width=Math.min(100,Math.round((buf.length/CAPTURE_MAX)*100))+"%";
    if(buf.length>=CAPTURE_MAX&&!autoJudge){autoJudge=true;setTimeout(()=>stopAndPredict(),300);}
  }

  async function predictOnce(){
    if(buf.length<20){alert("Not enough data.");return;}
    const fixed=temporalFix(buf,SEQ_LEN);
    const seq=fixed.flatMap(f=>Array.from(f));
    try{
      const res=await fetch("http://127.0.0.1:5000/predict?mode=live",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sequence:seq})});
      const j=await res.json();if(!j||!j.label)return;
      const predicted=j.label.split('_').pop().toLowerCase();
      const target=(targetGesture||"").toLowerCase();
      if(predicted===target){
        correctCount++;resultText.textContent="âœ… Correct";resultText.className="fs-4 fw-bold text-success";correctCountEl.textContent=correctCount;
      }else{
        incorrectCount++;resultText.textContent=`âŒ Incorrect (Predicted: ${j.label})`;
        resultText.className="fs-4 fw-bold text-danger";incorrectCountEl.textContent=incorrectCount;
      }
    }catch(e){console.error(e);}
  }

  async function stopAndPredict(){
    if(state!==STATE_CAPTURE&&state!==STATE_PREP)return;
    running=false;recBadge.style.display="none";capturePhase.textContent="Predictingâ€¦";
    camera.stop();await predictOnce();
    setTimeout(()=>{setState(STATE_READY);capturePhase.textContent="Idle";startBtn.style.display="inline-block";stopBtn.style.display="none";autoJudge=false;},300);
  }

  const holistic=new Holistic({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${f}`});
  holistic.setOptions({selfieMode:false,modelComplexity:2,smoothLandmarks:true,refineFaceLandmarks:false,minDetectionConfidence:0.55,minTrackingConfidence:0.55});
  holistic.onResults(res=>{
    ctx.save();ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
    ctx.drawImage(res.image,0,0,canvasEl.width,canvasEl.height);
    // drawConnectors(ctx,res.poseLandmarks,POSE_CONNECTIONS,{color:"#00FF00"});
    // drawConnectors(ctx,res.leftHandLandmarks,HAND_CONNECTIONS,{color:"#FF0000"});
    // drawConnectors(ctx,res.rightHandLandmarks,HAND_CONNECTIONS,{color:"#0000FF"});
    ctx.restore();
    const pose=res.poseLandmarks||[],shL=lm(pose,11),shR=lm(pose,12);
    const sd=(isFinite(shL.x)&&isFinite(shR.x))?dist2D(shL,shR).toFixed(3):'nan';
    hud.textContent=`ShoulderDist: ${sd}`;
    if(running&&state===STATE_CAPTURE){
      frameCounter++;
      if(frameCounter%frameSkip===0){
        const feat=packFeature(res);
        if(feat)updateBuffer(feat);
      }
    }
  });

  const camera=new Camera(videoEl,{onFrame:async()=>{await holistic.send({image:videoEl});},width:640,height:480});
  startBtn.onclick=()=>{if(!targetGesture){alert("Select a gesture first.");return;}
    buf=[];frameCounter=0;autoJudge=false;setState(STATE_PREP);
    prepOverlay.style.display="block";recBadge.style.display="none";
    startBtn.style.display="none";stopBtn.style.display="inline-block";
    resultText.textContent="â€”";capturePhase.textContent="Get Readyâ€¦";running=true;camera.start();
    setTimeout(()=>{setState(STATE_CAPTURE);prepOverlay.style.display="none";recBadge.style.display="inline-block";capturePhase.textContent="Perform Now (~5 s)â€¦";},1000);};
  stopBtn.onclick=async()=>{await stopAndPredict();};
});
</script>

{% endblock %}
